version: '3.8'

services:
  # 1. Local LLM Service (Ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama_service
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    restart: always
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # 2. Graph Database (FalkorDB) - Persistent
  falkordb:
    image: falkordb/falkordb:latest
    container_name: falkordb_ent
    ports:
      - "6380:6379" # Mapped to 6380
    volumes:
      - ./falkor_data:/var/lib/falkordb/data
    command: ["falkordb-server", "--appendonly", "yes"]

  # 3. Vector Database (Qdrant)
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage

  # 4. Message Queue (Redpanda)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    ports:
      - "9092:9092"
    command:
      - redpanda start
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092

  # 5. State & Cache (Standard Redis)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # 6. Metadata DB (Postgres)
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: pgpassword
      POSTGRES_DB: fed_meta
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  # 7. Visualization (RedisInsight)
  redisinsight:
    image: redis/redisinsight:latest
    container_name: redisinsight
    ports:
      - "5540:5540"
    volumes:
      - redisinsight_data:/data

volumes:
  ollama_models:
  redis_data:
  pg_data:
  redisinsight_data: